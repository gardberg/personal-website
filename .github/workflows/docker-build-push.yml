name: Docker Build and Push

on:
    push:
        branches:
            - main
            
env:
    REGISTRY: europe-north1-docker.pkg.dev
    IMAGE_NAME: ${{ github.repository }}
    ARTIFACT_NAME: personal-repo

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              
            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                credentials_json: ${{ secrets.GCP_SA_KEY }}
                
            - name: Set up gcloud CLI
              uses: google-github-actions/setup-gcloud@v2
              with:
                project_id: ${{ secrets.GCP_PROJECT_ID }}
                service_account_key: ${{ secrets.GCP_SA_KEY }}
                export_default_credentials: true
                
            - name: Configure Docker to use the Google Container Registry
              run: |
                gcloud auth configure-docker europe-north1-docker.pkg.dev
                
            - name: Build and push Docker image
              uses: docker/build-push-action@v4
              with:
                context: .
                file: Dockerfile
                push: true
                tags: ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                